name: Deploy to Railway

# Trigger this workflow on pushes to the main branch
on:
  push:
    branches: [ main ]

# Concurrency group ensures only one deployment runs at a time per branch,
# cancelling any in-progress ones if a new commit is pushed.
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

env:
  # Define environment variables available to all jobs in this workflow
  # Note: Avoid referencing secrets at the workflow-level to prevent context access errors.
  # Set secrets at the job or step level instead.
  # Add other environment variables here if needed for the workflow itself (not the app)

jobs:
  # A lightweight test job that has no dependencies (satisfies "at least one job with no dependencies")
  test:
    name: Run basic tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run placeholder tests
        run: |
          echo "No test suite configured in this repository. Marking test job as successful."
          # Replace the commands above with your actual test runner (e.g., npm test, pytest, etc.)

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: test # Now valid because there is a 'test' job in this workflow

    # Only run deployment on the main branch and after tests pass
    if: github.ref == 'refs/heads/main'

    steps:
      # 1. Check out the code from the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Download the Railway CLI
      - name: Download Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh

      # 3. Deploy the project using Railway CLI
      # This command will push the code and trigger a new deployment on Railway,
      # using the `railway.toml` and `Procfile` configuration.
      # It assumes your Railway project is linked to this repository.
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --detach # Use --detach to run the deployment asynchronously and not wait for build logs
          # Optionally, you can wait for the build to complete and check its status.
        # railway up # Without --detach, it waits and exits with the build status.
        # railway up # Without --detach, it waits and exits with the build status.

      # Optional: Add a step to verify the deployment status on Railway if Railway CLI supports it
      # or ping the deployed service's health check endpoint.
      # - name: Verify Deployment
      #   run: |
      #     # Example: Ping the health check endpoint
      #     # Replace YOUR_RAILWAY_APP_URL with your actual deployed URL or fetch it dynamically
      #     sleep 30 # Wait a bit for the service to start
      #     curl -f https://your-app-name.up.railway.app/health # Replace with actual URL and path