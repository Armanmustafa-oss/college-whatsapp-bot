# Troubleshooting Guide: College WhatsApp Bot

## Overview
This guide provides solutions for common issues encountered during the development, testing, deployment, and operation of the College WhatsApp Bot. It is intended for developers and operations staff.

## Common Issues & Solutions

### 1. Bot Not Responding to Messages

**Symptoms:**
*   User sends a message via WhatsApp, but receives no reply.
*   No new entries appear in the `conversations` table in Supabase for that message.

**Possible Causes & Steps:**

1.  **Incorrect Twilio Webhook Configuration:**
    *   **Check:** Log into your Twilio console. Verify the webhook URL under your WhatsApp number/Sandbox settings points to the correct deployed URL of your bot's `/webhook` endpoint (e.g., `https://your-app.railway.app/webhook`).
    *   **Fix:** Update the webhook URL in Twilio if it's incorrect.
2.  **Application Error / Crash:**
    *   **Check:** Review the logs on your deployment platform (e.g., Railway dashboard logs).
    *   **Look For:** `ERROR`, `CRITICAL`, or stack traces.
    *   **Common Errors:**
        *   Missing environment variables (Supabase URL/key, Groq API key, Twilio tokens).
        *   Incorrect environment variable values.
        *   Database connection failures.
        *   External API (Groq, Twilio) request failures.
    *   **Fix:** Correct the configuration or code based on the error message.
3.  **Rate Limiting:**
    *   **Check:** Logs might show messages indicating rate limits are hit.
    *   **Fix:** Adjust `RATE_LIMIT_MESSAGES` and `RATE_LIMIT_WINDOW` in your environment variables if necessary, or check if the user is genuinely exceeding the limit.
4.  **Network Issues:**
    *   **Check:** Ensure your deployment platform can reach external services (Supabase, Groq, Twilio endpoints).
    *   **Fix:** Check platform-specific network settings or firewall rules if applicable.

### 2. Slow Bot Response Times

**Symptoms:**
*   Users experience delays (several seconds) before receiving a response.
*   The dashboard shows high average response times.

**Possible Causes & Steps:**

1.  **Groq API Latency:**
    *   **Check:** Monitor Sentry for slow transactions related to the Groq API call. Check logs for Groq API response times.
    *   **Fix:** Check the Groq status page. Consider if the model being used (`GROQ_MODEL`) is appropriate for the required speed vs. quality. Monitor your API usage quota.
2.  **Database Query Latency:**
    *   **Check:** Monitor logs or Supabase performance metrics for slow queries, especially during the logging step in `bot/main.py`.
    *   **Fix:** Ensure indexes exist on the columns being queried (e.g., `timestamp` in `conversations`). Optimize queries if needed.
3.  **Vector Store (ChromaDB) Query Latency:**
    *   **Check:** Monitor logs for the RAG retrieval step (`retriever.py`, `vector_store.py`).
    *   **Fix:** Ensure the ChromaDB instance has sufficient resources. The size and number of documents in the `data/` folder can impact retrieval speed. Consider indexing strategies or hardware upgrades for large knowledge bases.
4.  **Application Bottleneck:**
    *   **Check:** Monitor application logs and system resources (CPU, memory) on the deployment platform.
    *   **Fix:** Optimize code in `prompt_engine.py` or `enhancer.py` if processing is intensive. Consider scaling the application instance if resources are maxed out.

### 3. Incorrect or Hallucinated Bot Responses

**Symptoms:**
*   Bot provides factually incorrect information.
*   Bot makes up information not present in the knowledge base.
*   Bot fails to find relevant information when it should be available.

**Possible Causes & Steps:**

1.  **Outdated or Incorrect Knowledge Base:**
    *   **Check:** Verify the documents in the `data/` folder contain the correct, up-to-date information.
    *   **Fix:** Update the documents and **re-run the `scripts/reindex_documents.py` script** to update the ChromaDB vector store.
2.  **Poor RAG Retrieval:**
    *   **Check:** Examine logs to see what context was retrieved for a given query. Was the correct information retrieved?
    *   **Fix:** The `vector_store.py` and `retriever.py` logic might need tuning (e.g., embedding model, search parameters like `top_k`).
3.  **Prompt Engineering Issues:**
    *   **Check:** Review the prompts generated by `prompt_engine.py`. Are they clear and instructing the AI correctly (e.g., to rely on context)?
    *   **Fix:** Refine the prompt templates in `prompt_engine.py` to be more specific or provide stronger instructions against hallucination.
4.  **AI Model Limitations:**
    *   **Check:** The chosen Groq model might be prone to hallucination or not suitable for the task.
    *   **Fix:** Experiment with different models available through Groq, potentially one better suited for factual Q&A.

### 4. Database Connection Issues

**Symptoms:**
*   Application logs show errors like "connection refused", "FATAL: password authentication failed", or "database does not exist".
*   Dashboard fails to load metrics.

**Possible Causes & Steps:**

1.  **Incorrect Supabase Credentials:**
    *   **Check:** Verify `SUPABASE_URL` and `SUPABASE_KEY` in your environment variables are correct and match your Supabase project.
    *   **Fix:** Update the environment variables with the correct values.
2.  **Supabase Project Down or Unavailable:**
    *   **Check:** Visit the Supabase dashboard. Check status pages or contact Supabase support.
    *   **Fix:** Wait for service restoration or contact support.
3.  **Connection Pool Exhaustion:**
    *   **Check:** Monitor Supabase logs and connection metrics. Check application logs for "too many connections" errors.
    *   **Fix:** Optimize database connection handling in the application code (though Supabase client libraries usually manage this). Consider scaling the Supabase database plan if consistently hitting limits.

### 5. Sentry Not Reporting Errors

**Symptoms:**
*   Expected errors from the application are not appearing in the Sentry dashboard.

**Possible Causes & Steps:**

1.  **Incorrect Sentry DSN:**
    *   **Check:** Verify `SENTRY_DSN` in your environment variables is correct.
    *   **Fix:** Update the environment variable with the correct DSN.
2.  **Sentry Not Initialized:**
    *   **Check:** Ensure `SentryManager.initialize()` is called during application startup in `bot/main.py` (or `lifespan` event).
    *   **Fix:** Verify initialization code is present and executed.
3.  **Errors Being Caught and Not Re-raised:**
    *   **Check:** Code might catch exceptions but not re-raise them or explicitly call `sentry_sdk.capture_exception()`.
    *   **Fix:** Ensure unhandled exceptions bubble up or are explicitly captured using the Sentry SDK.

### 6. Dashboard Not Loading or Showing Stale Data

**Symptoms:**
*   Dashboard page fails to load.
*   Charts show no data or data that is significantly out of date.

**Possible Causes & Steps:**

1.  **Dashboard Service Down:**
    *   **Check:** Verify the dashboard service (if deployed separately via `Procfile`) is running and accessible at its assigned URL. Check its logs.
    *   **Fix:** Restart the service or investigate application errors in its logs.
2.  **Database Connection Issues (from Dashboard's perspective):**
    *   **Check:** Verify the dashboard service has the correct `SUPABASE_URL` and `SUPABASE_KEY` in its environment variables (same as the bot service).
    *   **Fix:** Ensure credentials are correct and the database is accessible.
3.  **Slow Queries on Dashboard:**
    *   **Check:** Monitor logs for the dashboard service for slow query errors.
    *   **Fix:** The queries fetching data for the dashboard (in `dashboard/app.py`) might need optimization, or the database itself might be slow due to load or lack of indexes on the queried columns (e.g., in `daily_conversation_summary` view).

## General Debugging Tips

*   **Check Logs First:** Always start troubleshooting by examining the application logs on your deployment platform and any external monitoring tools (Sentry, Supabase logs).
*   **Verify Environment Variables:** Ensure all required environment variables are set correctly in the deployment environment.
*   **Test Components Individually:** If possible, test the RAG system, AI call, and database connection independently of the full webhook flow.
*   **Use Staging:** Reproduce issues in a staging environment that mirrors production before applying fixes.
*   **Monitor Metrics:** Use the dashboard and Sentry to identify patterns or anomalies preceding issues.